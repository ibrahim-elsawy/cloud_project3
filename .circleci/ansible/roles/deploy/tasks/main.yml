---

- name: upgrade npm
  become: true
  shell: |
    npm install -g npm@latest


- name: "Copy compiled backend"
  unarchive:
    src: /root/project/backend/backend.tar.gz
    dest: /home/ubuntu/

- name: install dependencies
  ignore_errors: yes
  shell: |
    cd /home/ubuntu/backend
    npm i
    npm run build

- name: "starting the server"
  become: true
  shell: |
    cd ~/backend
    TYPEORM_CONNECTION=postgres
    TYPEORM_ENTITIES=./src/modules/domain/**/*.entity.ts
    TYPEORM_HOST=database-2.c0eyxof0kjwt.us-east-1.rds.amazonaws.com
    TYPEORM_PORT = 5432
    TYPEORM_USERNAME=postgres
    TYPEORM_PASSWORD=sawy4507
    TYPEORM_DATABASE=postgres
    TYPEORM_MIGRATIONS=./src/migrations/*.ts
    TYPEORM_MIGRATIONS_DIR=./src/migrations
    ufw allow 3030/tcp
    pm2 stop default
    pm2 start npm -- start
    nmap localhost
    pm2 ls
  register: server_logs

- name: logs of the start server
  debug:
    msg: "{{ server_logs.stdout_lines }}"